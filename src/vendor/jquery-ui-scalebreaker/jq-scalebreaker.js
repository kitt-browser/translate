// Generated by CoffeeScript 1.6.3
(function() {
  (function($) {
    return $.widget("salsita.scalebreaker", {
      options: {
        cssAnimated: true,
        dialogContent: '',
        idNamespace: 'jq-scalebreaker',
        dialogPosition: 'bottom',
        closeOnBackdrop: true,
        denyUserScroll: true,
        refreshOnScroll: true,
        debug: false
      },
      _create: function() {
        this.rawElement = "<div id='" + this.options.idNamespace + "-wrapper'>          <div id='" + this.options.idNamespace + "-dialog-scalable'>            <div id='" + this.options.idNamespace + "-dialog-scrollable'>              <div id='" + this.options.idNamespace + "-dialog-content'></div>              <span id='" + this.options.idNamespace + "-dialog-close'></span>            </div>          </div>        </div>";
        this.scrollbar = null;
        this.wrapper = null;
        this.dialog = null;
        this.scrollarea = null;
        this.content = null;
        this.close = null;
        this.fullPageHeight = null;
        this.scaleFactor = null;
        this.currentViewportOffset = null;
        return this._initWidget();
      },
      _initWidget: function() {
        $('body').append(this.rawElement);
        this.wrapper = $('#' + this.options.idNamespace + '-wrapper');
        this.dialog = $('#' + this.options.idNamespace + '-dialog-scalable');
        this.scrollarea = $('#' + this.options.idNamespace + '-dialog-scrollable');
        this.content = $('#' + this.options.idNamespace + '-dialog-content');
        this.close = $('#' + this.options.idNamespace + '-dialog-close');
        return this.changeDialogContent(this.options.dialogContent);
      },
      _setFullPageHeight: function() {
        this.fullPageHeight = Math.max(document.body.offsetHeight, document.documentElement.clientHeight, document.documentElement.scrollHeight, document.documentElement.offsetHeight);
        return this.wrapper.css({
          'height': this.fullPageHeight
        });
      },
      _getCurrentViewport: function() {
        var bodyOverflow;
        bodyOverflow = $('body').css('overflow');
        $('body').css({
          'overflow': 'hidden'
        });
        this.scaleFactor = window.innerWidth / document.documentElement.clientWidth;
        this._logMessage('scale factor', this.scaleFactor);
        this.currentViewportOffset = [window.pageXOffset, window.pageYOffset];
        this._logMessage('current viewport offset', this.currentViewportOffset);
        return $('body').css({
          'overflow': bodyOverflow
        });
      },
      _rescaleAndReposition: function() {
        this.dialog.css({
          'left': this.currentViewportOffset[0],
          'transform': "scale(" + this.scaleFactor + ")",
          '-webkit-transform': "scale(" + this.scaleFactor + ")"
        });
        if (this.options.dialogPosition === 'top') {
          this.dialog.css({
            'top': this.currentViewportOffset[1],
            'transform-origin': '0 0',
            '-webkit-transform-origin': '0 0'
          });
        }
        if (this.options.dialogPosition === 'bottom') {
          return this.dialog.css({
            'bottom': this.fullPageHeight - (this.currentViewportOffset[1] + window.innerHeight),
            'transform-origin': '0 100%',
            '-webkit-transform-origin': '0 100%'
          });
        }
      },
      _manageScrollbar: function() {
        if (this.content.outerHeight() > this.scrollarea.outerHeight() && !this.scrollbar) {
          return this.scrollbar = new IScroll(this.scrollarea.get(0), {
            HWCompositing: true,
            useTransition: false,
            click: true
          });
        } else if (this.scrollbar) {
          return this.scrollbar.refresh();
        }
      },
      _logMessage: function(name, args) {
        if (this.options.debug) {
          return console.log("" + this.options.idNamespace + ": " + name, args);
        }
      },
      show: function() {
        var _self;
        _self = this;
        if (this.options.closeOnBackdrop) {
          _self.wrapper.on("click." + this.options.idNamespace, function(e) {
            if (e.target === _self.wrapper.get(0)) {
              return _self.hide();
            }
          });
        }
        this.close.on("click." + this.options.idNamespace, function(e) {
          return _self.hide();
        });
        if (this.options.denyUserScroll) {
          $('body').on("touchmove." + this.options.idNamespace, function(e) {
            return e.preventDefault();
          });
        }
        this.wrapper.addClass("" + this.options.idNamespace + "-show");
        this.refresh();
        if (this.options.cssAnimated) {
          this.wrapper.addClass("" + this.options.idNamespace + "-animate-in");
          this.wrapper.on('animationend webkitAnimationEnd', function(e) {
            if (e.target === _self.scrollarea.get(0)) {
              _self.wrapper.removeClass("" + _self.options.idNamespace + "-animate-in");
              return _self.wrapper.off('animationend webkitAnimationEnd');
            }
          });
        }
        if (this.options.refreshOnScroll) {
          $(window).on("scroll." + this.options.idNamespace, function(e) {
            return _self.refresh();
          });
        }
        return this._logMessage('showing widget');
      },
      hide: function() {
        var _self;
        _self = this;
        if (this.options.denyUserScroll) {
          $('body').off("touchmove." + this.options.idNamespace);
        }
        if (this.options.closeOnBackdrop && this.options.cssAnimated) {
          _self.wrapper.off("click." + this.options.idNamespace);
          this.wrapper.addClass("" + this.options.idNamespace + "-animate-out");
          this.wrapper.on('animationend webkitAnimationEnd', function(e) {
            if (e.target === _self.scrollarea.get(0)) {
              _self.wrapper.removeClass("" + _self.options.idNamespace + "-animate-out");
              _self.wrapper.removeClass("" + _self.options.idNamespace + "-show");
              return _self.wrapper.off('animationend webkitAnimationEnd');
            }
          });
        } else if (this.options.closeOnBackdrop) {
          _self.wrapper.off("click." + this.options.idNamespace);
          this.wrapper.removeClass("" + this.options.idNamespace + "-show");
        }
        if (this.options.refreshOnScroll) {
          $(window).off("scroll." + this.options.idNamespace);
        }
        return this._logMessage('hiding widget');
      },
      changeDialogContent: function(content) {
        this.content.html(content);
        this.refresh();
        return this._logMessage('adding content to dialog', content);
      },
      refresh: function() {
        this._setFullPageHeight();
        this._getCurrentViewport();
        this._rescaleAndReposition();
        this._manageScrollbar();
        return this._logMessage('refreshing');
      },
      destroy: function() {
        $(window).off("scroll." + this.options.idNamespace);
        this.wrapper.remove();
        this.rawElement = null;
        this.wrapper = null;
        this.dialog = null;
        this.scrollarea = null;
        this.content = null;
        this.close = null;
        this.scaleFactor = null;
        this.fullPageHeight = null;
        this.currentViewportOffset = null;
        if (this.scrollbar) {
          this.scrollbar.destroy();
        }
        this.scrollbar = null;
        return this._destroy();
      },
      _destroy: $.noop
    });
  })(jQuery);

}).call(this);
